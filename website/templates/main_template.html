<!doctype html>

<head>
    <title>{% block title %}{% endblock %} - Flaskr</title>
    <link rel="stylesheet"
        href="{{ url_for('static', filename='style.css') }}">
    <script src="{{ url_for('static', filename='main_template') }}">
    </script>
</head>

<body>
    <h1>Testing</h1>
    <input type="button" value="Save" onclick="save()" />
    <input type="button" value="Upper case" onclick="upper()" />
    <div id="container">
        <div id="left_panel">
            {{
                rocher_editor(
                    "left_panel",
                    "yuda_asm",
                    source_code,
                    readOnly=false,
                    theme="vs-dark",
                    lineHeight=20,
                    minimap={"enabled": True},
                    automaticLayout=true,
                )
            | safe }}
        </div>
    </div>
    <!-- You can access to the editor instance via module rocher_editor followed by the container id -->
    <script>
        // setup editor
        require(['rocher_editor_left_panel'], function (editor) {
            // bind F9 for running
            var myBinding = editor.addCommand(monaco.KeyCode.F9, function () {
                alert("F9 pressed!");
            });
            
            /*********************************************************\
            |               SETTING UP YUDA_ASM LANGUAGE              *
            \*********************************************************/
            monaco.languages.register({
                id: "yuda_asm"
            });
            
            // syntax highlighting
            monaco.languages.setMonarchTokensProvider("yuda_asm", {
                // Set defaultToken to invalid to see what you do not tokenize yet
                // defaultToken: 'invalid',

                keywords: [
                    'mov', 'cmp', 'jmp', 'je', 'jl', 'ret', 'add', 'sub',
                    'MOV', 'CMP', 'JMP', 'JE', 'JL', 'RET', 'ADD', 'SUB'
                ],


                typeKeywords: [
                    'ax', 'bx', 'ptr',
                    'AX', 'BX', 'PTR'
                ],

                operators: [',', ],

                symbols: /[,]+/,

                // The main tokenizer for our languages
                tokenizer: {
                    root: [
                        // identifiers and keywords
                        [/[a-z_$][\w$]*/, {
                            cases: {
                                '@typeKeywords': 'keyword',
                                '@keywords': 'keyword',
                                '@default': 'identifier'
                            }
                        }],

                        // whitespace
                        {
                            include: '@whitespace'
                        },

                        // delimiters and operators
                        [/[{}()\[\]]/, '@brackets'],
                        [/@symbols/, {
                            cases: {
                                '@operators': 'operator',
                                '@default': ''
                            }
                        }],

                        // label
                        [/\.[\w0-9-_]+/, 'label'],

                        // numbers
                        [/0[xX][0-9a-fA-F]+/, 'number.hex'],
                        [/\d+/, 'number'],
                    ],

                    whitespace: [
                        [/[ \t\r\n]+/, 'white'],
                        [/;.*$/, 'comment'],
                    ],
                },
            });

            // very simple autocomplete
            monaco.languages.registerCompletionItemProvider("yuda_asm", {
                provideCompletionItems: (model, position) => {
                    var word = model.getWordUntilPosition(position);
                    var range = {
                        startLineNumber: position.lineNumber,
                        endLineNumber: position.lineNumber,
                        startColumn: word.startColumn,
                        endColumn: word.endColumn,
                    };
                    var suggestions = [];
                    ['mov', 'cmp', 'jmp', 'je', 'jl', 'ret', 'add', 'sub', 'ax', 'bx', 'ptr'].forEach((item) => {
                        suggestions.push({
                            label: item,
                            kind: monaco.languages.CompletionItemKind.Keyword,
                            insertText: item,
                            range: range,
                        });
                    });
                    return { suggestions: suggestions };
                },
            });

        });

        function save() {
            require(['rocher_editor_left_panel'], function (editor) {
                var source_code = editor.getValue();
                alert(source_code);
            });
        }
    </script>

</body>